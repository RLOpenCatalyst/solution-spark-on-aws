image: $CI_REGISTRY_IMAGE

variables:
  SECRET_DETECTION_REPORT_FILE: gl-secret-detection-report.json
  CONTAINER_SCANNING_REPORT_FILE: gl-container-scanning-report.json

stages:
  - build-image
  - build-and-test
  - security-scan
  - security-scan-eval

build_image:
  stage: build-image
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n ${CI_REGISTRY_USER}:${CI_BUILD_TOKEN} | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      exists:
        - Dockerfile

.base:
  script:
    - aws codeartifact login --domain ${CODEARTIFACT_DOMAIN_NAME} --domain-owner ${CODEARTIFACT_DOMAIN_OWNER} --repository ${CODEARTIFACT_REPO_NAME} --region ${REGION} --tool ${CODEARIFACT_PACKAGE_FORMAT}
    - npm config list
    - echo "Fetch the main branch"
    - git fetch origin main:refs/remotes/origin/main -a
    - echo "Install NPM packages in the common folder"
    - node common/scripts/install-run-rush.js install
    - node common/scripts/install-run-rush.js check
    - node common/scripts/install-run-rush.js rebuild --verbose
    - node common/scripts/install-run-rush.js test:only --verbose
    # Throw an error if the generated code coverage badges do not match what is already in each package README file
    - node common/scripts/install-run-rush.js make-badges --ci
    # Throw an error if the generated code coverage badges do not match what is already in the root README file
    - node common/scripts/install-run-rush.js common-coverage-ci

build-and-test:
  extends: 
    - .base
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: on_success
  stage: build-and-test

include:
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/SAST-IaC.latest.gitlab-ci.yml
  - template: Jobs/License-Scanning.gitlab-ci.yml

# Overrides for Security and Jobs templates to run during merge request
container_scanning:
  stage: security-scan
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'schedule'
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - env
    - gtcs scan
  variables:
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE

license_scanning:
  stage: security-scan
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

sast:
  stage: security-scan

eslint-sast:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

nodejs-scan-sast:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

semgrep-sast:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

.secret-analyzer:
  stage: security-scan
    
secret_detection:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  artifacts:
    paths:
      # in the "parent" job this file is declared as a report artifact, but
      # we also need it as a regular artifact for the subsequent job
      - $SECRET_DETECTION_REPORT_FILE

iac-sast:
  stage: security-scan

kics-iac-sast:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

## Fail on Secret
secret-scan-eval:
  stage: security-scan-eval
  dependencies:
    - secret_detection
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  variables:
    # this job only requires the $SECRET_DETECTION_REPORT_FILE
    GIT_STRATEGY: none
  script:
    # check if '{ "vulnerabilities": [], ..' is empty in the report file if it exists
    - |
      if [ -f "$SECRET_DETECTION_REPORT_FILE" ]; then
        if [ "$(jq ".vulnerabilities | length" $SECRET_DETECTION_REPORT_FILE)" -gt 0 ]; then
          echo "Vulnerabilities detected. Please analyze the artifact $SECRET_DETECTION_REPORT_FILE produced by the 'secret-detection' job."
          exit 1
        fi
      else
        echo "Artifact $SECRET_DETECTION_REPORT_FILE does not exist. The 'secret-detection' job likely didn't create one. Hence, no evaluation can be performed."
      fi

## Fail on Container Vulnerability
container-scan-eval:
  stage: security-scan-eval
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  dependencies:
    - container_scanning
  variables:
    # this job only requires the $CONTAINER_SCANNING_REPORT_FILE
    GIT_STRATEGY: none
  script:
    # check if '{ "vulnerabilities": [], ..' is empty in the report file if it exists
    - |
      if [ -f "$CONTAINER_SCANNING_REPORT_FILE" ]; then
        if [ "$(jq ".vulnerabilities | length" $CONTAINER_SCANNING_REPORT_FILE)" -gt 0 ]; then
          echo "Vulnerabilities detected. Please analyze the artifact $CONTAINER_SCANNING_REPORT_FILE produced by the 'secret-detection' job."
          exit 1
        fi
      else
        echo "Artifact $CONTAINER_SCANNING_REPORT_FILE does not exist. The 'container_scanning' job likely didn't create one. Hence, no evaluation can be performed."
      fi
