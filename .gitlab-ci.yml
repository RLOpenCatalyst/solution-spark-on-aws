image: registry.gitlab.aws.dev/ma-foundation/ma-mono/node14-awscli:latest

workflow:
  rules:
    - changes:
      - "*/**/*"
      - "*"

stages:
  - .pre
  - build
  - test

.base:
  before_script:
    - aws codeartifact login --domain ${CODEARTIFACT_DOMAIN_NAME} --domain-owner ${CODEARTIFACT_DOMAIN_OWNER} --repository ${CODEARTIFACT_REPO_NAME} --region ${REGION} --tool ${CODEARIFACT_PACKAGE_FORMAT}
    - npm config list
    - node common/scripts/install-run-rush.js update

rush-check:
  extends: 
    - .base
  stage: .pre
  script:
    # Checks each project's package.json files and ensures that all dependencies are of the same version throughout the repository.
    - node common/scripts/install-run-rush.js check
    - env

.feature-base:
  script:
    - echo "Building package $PACKAGE_NAME"
    - node common/scripts/install-run-rush.js build --from "@$CODEARTIFACT_NAMESPACE/$PACKAGE_NAME" -v
    - node common/scripts/install-run-rush.js test --from "@$CODEARTIFACT_NAMESPACE/$PACKAGE_NAME" -v

feature-environment:
  extends: 
    - .base
    - .feature-base
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: never
    - changes:
      - "*/environments/**/*.ts"
      variables:
        PACKAGE_NAME: 'environments'
      when: on_success
  stage: build

feature-swb-app:
  extends: 
    - .base
    - .feature-base
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: never
    - changes:
      - "*/swb-app/**/*.ts"
      variables:
        PACKAGE_NAME: 'swb-app'
      when: on_success
  stage: build

feature-swb-reference:
  extends: 
    - .base
    - .feature-base
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: never
    - changes:
      - "*/swb-reference/**/*.ts"
      variables:
        PACKAGE_NAME: 'swb-reference'
      when: on_success
  stage: build

feature-swb-reference-lambda:
  extends: 
    - .base
    - .feature-base
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: never
    - changes:
      - "*/swb-reference/lambda/**/*.ts"
      variables:
        PACKAGE_NAME: 'swb-reference/lambda'
      when: on_success
  stage: build

main:
  extends: 
    - .base
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: on_success
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
  stage: build
  script:
    - echo "Build all packages"
    - node common/scripts/install-run-rush.js build -v
    - node common/scripts/install-run-rush.js test -v

include:
  template: Jobs/SAST.gitlab-ci.yml