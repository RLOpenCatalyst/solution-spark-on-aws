image: $CI_REGISTRY_IMAGE/node14-awscli-git:latest

stages:
  - build-and-test
  - secret-scan

.base:
  script:
    - aws codeartifact login --domain ${CODEARTIFACT_DOMAIN_NAME} --domain-owner ${CODEARTIFACT_DOMAIN_OWNER} --repository ${CODEARTIFACT_REPO_NAME} --region ${REGION} --tool ${CODEARIFACT_PACKAGE_FORMAT}
    - npm config list
    - echo "Fetch the main branch"
    - git fetch origin main:refs/remotes/origin/main -a
    - echo "Install NPM packages in the common folder"
    - node common/scripts/install-run-rush.js install
    - node common/scripts/install-run-rush.js check
    - node common/scripts/install-run-rush.js rebuild --verbose
    - node common/scripts/install-run-rush.js test --verbose

build-and-test:
  extends: 
    - .base
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: on_success
  stage: build-and-test

include:
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/SAST-IaC.latest.gitlab-ci.yml
  - template: Jobs/License-Scanning.gitlab-ci.yml

# Overrides for Security and Jobs templates to run during merge request
container_scanning:
  stage: secret-scan
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  variables:
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE/node14-awscli-git:latest

license_scanning:
  stage: secret-scan
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

sast:
  stage: secret-scan

eslint-sast:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

nodejs-scan-sast:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

semgrep-sast:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

.secret-analyzer:
  stage: secret-scan
    
secret_detection:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

iac-sast:
  stage: secret-scan

kics-iac-sast:
  rules: 
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'